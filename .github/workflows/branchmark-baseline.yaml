name: Generate branchmark baseline

on:
  workflow_dispatch:  # Only runs when manually triggered
    inputs:
      commit_message:
        description: 'Custom commit message for baselines'
        required: false
        default: 'Update baseline benchmarks'

permissions:
  contents: write  # Need write permission to commit

jobs:
  generate-baselines:
    runs-on: macos-latest  # Same as your benchmark runner
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true
      
      - name: Install dependencies
        run: |
          install.packages(c("bench", "devtools", "readr", "stringr"))
          devtools::install_deps()
        shell: Rscript {0}
      
      - name: Generate baseline benchmarks
        run: |
          source("branchmark/generate_baselines.R")
        shell: Rscript {0}
      
      - name: Commit and push baselines
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add any new or modified baseline files
          git add branchmark/branchmark_main_*.rds
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to baseline files"
          else
            git commit -m "${{ github.event.inputs.commit_message }}"
            git push
            echo "Baseline files updated and committed"
          fi